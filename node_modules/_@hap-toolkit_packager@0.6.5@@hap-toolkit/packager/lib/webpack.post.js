"use strict";const fs=require("fs"),path=require("path"),globalConfig=require("@hap-toolkit/shared-utils/config"),{initOptions:initOptions,options:compileOptions}=require("@hap-toolkit/shared-utils/compilation-config"),CopyDslPlugin=require("./plugin/copy-dsl-plugin"),HandlerPlugin=require("./plugin/handler-plugin"),ResourcePlugin=require("./plugin/resource-plugin"),ZipPlugin=require("./plugin/zip-plugin"),NotifyPlugin=require("./plugin/notify-plugin"),SourcemapFixPlugin=require("./plugin/sourcemap-fix-plugin"),{colorconsole:colorconsole,loadBabelModule:loadBabelModule}=require("./common/utils");function genPriorities(e){const o=[/^i18n\/.+\.json$/i,"manifest.json","app.js",/^common\//i];if(e&&e.router&&e.router.entry){const i=e.router.entry;o.splice(2,0,new RegExp(`^${i}/$`),new RegExp(`^${i}/.+`))}else colorconsole.error("manifest.json 中未配置入口页面 router.entry");return o}function getManifest(e){let o;try{const i=fs.readFileSync(e).toString();o=JSON.parse(i)}catch(e){colorconsole.error(`读取 manifest.json 失败： ${e.message}`)}return o||{}}function resolveLoader(e){return require.resolve(`./loader/${e}`)}function postHook(e,o,i){const n=globalConfig.projectPath,{appPackageName:r,versionCode:s,pathDist:t,pathBuild:l,pathSignFolder:u,pathSrc:a,subpackages:p,workers:c}=o;initOptions(i);const g=getManifest(path.join(a,"manifest.json")),d=genPriorities(g);e.module.rules.push({test:/\.js$/,use:[resolveLoader("module-loader.js"),{loader:loadBabelModule("babel-loader"),options:{cwd:n,cacheDirectory:!0}}]});const m="dev"===process.env.NODE_PHASE&&i.sign,f="dev"!==process.env.NODE_PHASE&&!i.debug,h=m||f,P=h?"release":"debug",b=JSON.stringify({toolkit:require("../package.json").version,timeStamp:(new Date).toJSON(),node:process.version,platform:process.platform,arch:process.arch,extends:i.packageExtends||null});if(i.includeDslFromLib&&e.plugins.unshift(new CopyDslPlugin({cwd:n,config:g.config})),e.plugins.push(new HandlerPlugin({pathSrc:a,workers:c}),new ResourcePlugin({src:a,dest:l,sign:h,projectRoot:globalConfig.projectPath,optimizeUnusedResource:i.optimizeUnusedResource}),new ZipPlugin({name:r,versionCode:s,output:t,pathBuild:l,pathSignFolder:u,sign:P,priorities:d,subpackages:p,comment:b,cwd:n,disableStreamPack:i.disableStreamPack,disableSubpackages:i.disableSubpackages}),new NotifyPlugin),i.matchSourcemap&&e.plugins.push(new SourcemapFixPlugin),compileOptions.stats){const o=require("webpack-bundle-analyzer").BundleAnalyzerPlugin;e.plugins.push(new o({analyzerMode:"static",openAnalyzer:!1,excludeAssets:/^@(system|service)\./}))}}module.exports={postHook:postHook};
//# sourceMappingURL=webpack.post.js.map
